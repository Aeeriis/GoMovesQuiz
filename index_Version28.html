<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pokémon Go Moveset Energy Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
  <link rel="manifest" href="manifest.json">
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #fafaff; }
    .container { max-width: 480px; margin: auto; padding: 1em; }
    h1 { font-size: 1.6em; }
    .quiz-section { margin-top: 2em; }
    .result { margin-top: 1em; font-weight: bold; }
    input[type="number"] { width: 90%; font-size: 1.2em; }
    button { font-size: 1.1em; padding: 0.6em 1.2em; margin-top: 1em;}
    label { font-size: 1.1em; }
    #question { font-size: 1.15em; margin-bottom: 1em; }
    #stats { font-size: 1.1em; margin: 0.8em 0; }
    #avgstats { font-size: 1em; margin: 0.2em 0 0.8em 0; color: #234;}
    #difficultySelect, #timerToggle { font-size: 1em; margin-bottom: 1em;}
    #difficultyWrap { margin-bottom: 0.2em; }
    #metaSettingsWrap {
      margin: 1.2em 0 0.5em 0;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    #metaBox {
      font-size: 1.08em;
      color: #333;
      margin: 0;
      margin-bottom: 0.7em;
      display: flex;
      align-items: center;
      gap: 1.3em;
      user-select: none;
      justify-content: flex-start;
      padding-left: 0;
    }
    #metaSelect {
      font-size: 1em;
      margin-right: 1.2em;
    }
    #metaScoreLabel {
      font-size: 0.97em;
      font-weight: bold;
      user-select: none;
      cursor: pointer;
      display: flex;
      align-items: center;
    }
    #metaScore {
      vertical-align: middle;
      margin-right: 0.4em;
      accent-color: #228be6;
    }
    #intro-explanation { margin: 1.1em 0 0.7em 0; background: #f0f7ff; border-radius: 8px; padding: 0.8em; font-size: 1.07em; color: #234; }
    #fixedNextWrap {
      display: none;
      position: fixed;
      left: 0; right: 0; bottom: 0;
      background: transparent;
      z-index: 100;
      text-align: center;
      pointer-events: none;
    }
    #fixedNextWrap.show {
      display: block;
    }
    #fixedNextBtn {
      font-size: 1.18em;
      padding: 0.75em 2.2em;
      background: #fff;
      color: #228be6;
      border: 2.5px solid #228be6;
      border-radius: 32px;
      box-shadow: 0 2px 14px #228be644, 0 1.5px 0 #eee inset;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 2.5em;
      pointer-events: auto;
      transition: background .18s, color .18s, border .18s;
      position: relative;
    }
    #fixedNextBtn:hover, #fixedNextBtn:focus {
      background: #228be6;
      color: #fff;
      border-color: #228be6;
      outline: none;
    }
    #fixedNextBtn:active {
      background: #1864ab;
      color: #fff;
      border-color: #1864ab;
    }
    #fixedNextWrap .close-next-btn {
      background: none;
      border: none;
      font-size: 1.5em;
      color: #888;
      cursor: pointer;
      position: absolute;
      right: 0.2em;
      top: -0.9em;
      pointer-events: auto;
      z-index: 3;
      padding: 0;
      line-height: 1;
      opacity: 0.7;
      transition: color .18s, opacity .15s;
    }
    #fixedNextWrap .close-next-btn:hover {
      color: #228be6;
      opacity: 1;
    }
    #fixedNextBtnWrap {
      display: inline-block;
      position: relative;
    }
    #timerSettingsWrap {
      margin-bottom: 1em;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
    }
    #timerBox {
      font-size: 1.08em;
      color: #333;
      margin: 0;
      margin-bottom: 0.8em;
      display: flex;
      align-items: center;
      gap: 1.2em;
      user-select: none;
      justify-content: flex-start;
      padding-left: 0;
    }
    #timer {
      min-width: 7em;
      font-weight: bold;
      display: inline-block;
      text-align: left;
      visibility: hidden;
      transition: opacity 0.2s;
    }
    .timer-visible {
      visibility: visible !important;
    }
    /* Toggle Switch Styling */
    .switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 28px;
      vertical-align: middle;
      margin-right: 0.5em;
      flex-shrink: 0;
    }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .3s;
      border-radius: 34px;
      border: 2.5px solid #bbb;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 2.7px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
      box-shadow: 0 2px 4px #0001;
    }
    input:checked + .slider {
      background-color: #228be6;
      border-color: #228be6;
    }
    input:checked + .slider:before {
      transform: translateX(17px);
    }
    #timerToggleLabel {
      font-size: 1.07em;
      user-select: none;
      cursor: pointer;
      font-weight: bold;
      display: flex;
      align-items: center;
      margin-left: 0em;
      margin-top: 0.33em;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.2em; }
      .container { padding: 0.5em; }
      #intro-explanation { font-size: 0.97em; }
      #fixedNextBtn { font-size: 1em; padding: 0.7em 1.5em; }
      #fixedNextWrap { padding-bottom: 0em; }
      #timerBox { font-size: 1em; gap: 0.7em; }
      #timerToggleLabel { font-size: 1em; }
      #fixedNextBtn { margin-bottom: 2em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Pokémon Go Moveset Energy Quiz</h1>
    <div id="intro-explanation">
      <b>How the quiz works:</b><br>
      <ul>
        <li><b>Basic</b> – "How many fast moves do you need for the <u>first</u> charged move?"</li>
        <li><b>Multi-Charge</b> – "How many fast moves do you need for the <u>1st, 2nd, 3rd, or 4th</u> charged move?"</li>
        <li><b>Combo</b> – "After using a certain number of one charged move, how many fast moves are needed for a different charged move?" (Combo mode now also includes Multi-Charge questions; combo questions are 1/3 of the total)</li>
      </ul>
      After each answer, an explanation with energy breakdown is shown to help you learn!
    </div>
    <div id="difficultyWrap">
      <label for="difficultySelect"><b>Difficulty:</b></label>
      <select id="difficultySelect">
        <option value="basic">Basic</option>
        <option value="multi">Multi-Charge</option>
        <option value="combo">Combo</option>
      </select>
    </div>
    <div id="metaSettingsWrap">
      <div id="metaBox">
        <label for="metaSelect"><b>Meta:</b></label>
        <select id="metaSelect"></select>
        <label id="metaScoreLabel" title="Only show Pokémon with score above 80 in this meta">
          <input type="checkbox" id="metaScore" />
          Only Score &gt; 80
        </label>
      </div>
      <div id="metaWarn" style="color:#b00;font-size:0.98em;padding:0.1em 0 0.2em 0;"></div>
      <div style="font-size:0.9em;color:#888;margin-top:0.2em;">
        <span>Showing only first 10 metas. <a href="https://github.com/Aeeriis/moves/tree/main/rankings" target="_blank">See all</a></span>
      </div>
    </div>
    <div id="timerSettingsWrap">
      <label id="timerToggleLabel">
        <span class="switch">
          <input type="checkbox" id="timerToggle">
          <span class="slider"></span>
        </span>
        Show time
      </label>
      <div id="timerBox">
        <span id="timer"></span>
      </div>
    </div>
    <div id="stats"></div>
    <div id="avgstats"></div>
    <div id="loading">Loading data...</div>
    <div class="quiz-section hidden" id="quizSection">
      <div id="question"></div>
      <form id="answerForm">
        <label for="userAnswer">Your answer:</label>
        <input type="number" id="userAnswer" min="1" required autocomplete="off" />
        <button type="submit">Check</button>
      </form>
      <div class="result" id="result"></div>
      <button id="nextQuestion" class="hidden" style="display:none;">Next Question</button>
      <button id="resetStats" style="margin-top:1em;">Reset Stats</button>
    </div>
  </div>
  <!-- Floating Next Question button, now draggable and can be closed -->
  <div id="fixedNextWrap">
    <span id="fixedNextBtnWrap">
      <button id="fixedNextBtn" type="button">Next Question</button>
      <button id="closeNextBtn" class="close-next-btn" title="Hide Next Question button" aria-label="Hide Next Question">&times;</button>
    </span>
  </div>
  <script>
    // Meta CSVs from GitHub (incomplete, max 10 shown here)
    const metaCSVFILES = [
      { name: "cp10000_all_overall_rankings.csv", path: "rankings/cp10000_all_overall_rankings.csv" },
      { name: "cp10000_battlefrontiermaster_overall_rankings.csv", path: "rankings/cp10000_battlefrontiermaster_overall_rankings.csv" },
      { name: "cp10000_premier_overall_rankings.csv", path: "rankings/cp10000_premier_overall_rankings.csv" },
      { name: "cp1500_all_overall_rankings.csv", path: "rankings/cp1500_all_overall_rankings.csv" },
      { name: "cp1500_catch_overall_rankings.csv", path: "rankings/cp1500_catch_overall_rankings.csv" },
      { name: "cp1500_gbinvitational_overall_rankings.csv", path: "rankings/cp1500_gbinvitational_overall_rankings.csv" },
      { name: "cp1500_rivalry_overall_rankings.csv", path: "rankings/cp1500_rivalry_overall_rankings.csv" },
      { name: "cp1500_tempo_overall_rankings.csv", path: "rankings/cp1500_tempo_overall_rankings.csv" },
      { name: "cp1500_wasteland_overall_rankings.csv", path: "rankings/cp1500_wasteland_overall_rankings.csv" },
      { name: "cp2500_all_overall_rankings.csv", path: "rankings/cp2500_all_overall_rankings.csv" },
      // ... limited by GitHub API, view all at: https://github.com/Aeeriis/moves/tree/main/rankings
    ];
    const metaRootURL = "https://raw.githubusercontent.com/Aeeriis/moves/main/";

    // Meta selection state
    let currentMeta = localStorage.getItem("quizMeta") || metaCSVFILES[0].name;
    let onlyHighScore = localStorage.getItem("onlyHighScore") === "true";
    let metaPokes = [];

    // Stats logic (localStorage)
    let stats = JSON.parse(localStorage.getItem('quizStats') ||
      '{"total":0,"correct":0,"sumTime":0,"sumTimeRight":0,"rightCount":0}');
    if (stats.sumTime === undefined) stats.sumTime = 0;
    if (stats.sumTimeRight === undefined) stats.sumTimeRight = 0;
    if (stats.rightCount === undefined) stats.rightCount = stats.correct || 0;

    function saveStats() {
      localStorage.setItem('quizStats', JSON.stringify(stats));
    }
    function showStats() {
      document.getElementById('stats').textContent =
        `Score: ${stats.correct}/${stats.total} (${stats.total ? Math.round(100 * stats.correct / stats.total) : 0}%)`;
      let avg = stats.total ? (stats.sumTime / stats.total) : 0;
      let avgRight = stats.rightCount ? (stats.sumTimeRight / stats.rightCount) : 0;
      document.getElementById('avgstats').textContent =
        `Average time: ${stats.total ? avg.toFixed(2) + " s" : "-"}   |   Average for correct: ${stats.rightCount ? avgRight.toFixed(2) + " s" : "-"}`;
    }
    showStats();

    // Timer logic
    let timerStart = null, timerInterval = null, timerActive = false;
    const timerSpan = document.getElementById('timer');
    const timerBox = document.getElementById('timerBox');
    const timerToggle = document.getElementById('timerToggle');
    const timerToggleLabel = document.getElementById('timerToggleLabel');
    // Remember timer preference
    let timerEnabled = localStorage.getItem('timerEnabled');
    if (timerEnabled === null) timerEnabled = "true";
    timerEnabled = timerEnabled === "true";
    timerToggle.checked = timerEnabled;

    function updateTimerVisibilityOnQuestion() {
      timerSpan.classList.remove('timer-visible');
      timerSpan.textContent = "";
    }
    function updateTimerVisibilityOnAnswer(timeText) {
      if (timerEnabled && timeText) {
        timerSpan.textContent = timeText;
        timerSpan.classList.add('timer-visible');
      } else {
        timerSpan.classList.remove('timer-visible');
        timerSpan.textContent = "";
      }
    }
    timerToggle.onchange = function() {
      timerEnabled = timerToggle.checked;
      localStorage.setItem('timerEnabled', timerEnabled ? "true" : "false");
      if (!timerEnabled) updateTimerVisibilityOnAnswer();
    };

    function startTimer() {
      timerStart = Date.now();
      timerActive = true;
      timerSpan.classList.remove('timer-visible');
      timerSpan.textContent = "";
      if (timerInterval) clearInterval(timerInterval);
    }
    function stopTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      timerActive = false;
    }
    function getTimerElapsed() {
      if (!timerStart) return 0;
      return (Date.now() - timerStart) / 1000;
    }

    // Difficulty logic
    let difficulty = localStorage.getItem("quizDifficulty") || "multi";
    document.getElementById('difficultySelect').value = difficulty;
    document.getElementById('difficultySelect').onchange = function() {
      difficulty = this.value;
      localStorage.setItem("quizDifficulty", difficulty);
      newQuestion();
    };

    document.getElementById('resetStats').onclick = function() {
      stats = { total: 0, correct: 0, sumTime: 0, sumTimeRight: 0, rightCount: 0 };
      saveStats();
      showStats();
    };

    // Meta menu logic
    function populateMetaMenu() {
      const metaSelect = document.getElementById('metaSelect');
      metaSelect.innerHTML = "";
      metaCSVFILES.forEach(meta => {
        let opt = document.createElement("option");
        opt.value = meta.name;
        opt.textContent = meta.name.replace(/\.csv$/,"");
        metaSelect.appendChild(opt);
      });
      metaSelect.value = currentMeta;
      document.getElementById('metaScore').checked = onlyHighScore;
    }
    populateMetaMenu();

    document.getElementById('metaSelect').onchange = function() {
      currentMeta = this.value;
      localStorage.setItem("quizMeta", currentMeta);
      loadMetaAndApply();
    };
    document.getElementById('metaScore').onchange = function() {
      onlyHighScore = this.checked;
      localStorage.setItem("onlyHighScore", onlyHighScore);
      loadMetaAndApply();
    };

    function loadMetaAndApply() {
      document.getElementById('metaWarn').textContent = "";
      fetch(metaRootURL + metaCSVFILES.find(m => m.name === currentMeta).path)
        .then(r => r.text())
        .then(csv => {
          const lines = csv.trim().split(/\r?\n/);
          if (lines.length < 2) {
            metaPokes = [];
            document.getElementById('metaWarn').textContent = "No Pokémon found for this meta.";
            return;
          }
          const head = lines[0].split(",");
          const idxName = head.indexOf("speciesName");
          const idxScore = head.map(x => x.trim().toLowerCase()).indexOf("score");
          if (idxName === -1 || idxScore === -1) {
            metaPokes = [];
            document.getElementById('metaWarn').textContent = "Meta CSV missing speciesName or score column.";
            return;
          }
          metaPokes = lines.slice(1)
            .map(l => l.split(","))
            .filter(row => !onlyHighScore || (parseFloat(row[idxScore]) > 80))
            .map(row => row[idxName]);
          if (!metaPokes.length) {
            document.getElementById('metaWarn').textContent = "No Pokémon with Score > 80 in this meta.";
          }
          newQuestion();
        });
    }

    // Helper: get ordinal text for numbers
    function getOrdinalText(n) {
      return ["1st","2nd","3rd","4th","5th","6th","7th","8th","9th","10th"][n-1] || (n+"th");
    }

    // Patch: Use metaPokes for pickEligiblePokemon()
    function pickEligiblePokemon() {
      let eligible = pokedex.filter(poke => {
        let fastList = (poke.fastMoves || []).filter(mv => !!movesByName[mv]);
        let chargeList = (poke.chargedMoves || []).filter(mv => !!movesByName[mv]);
        return fastList.length && chargeList.length && (!metaPokes.length || metaPokes.includes(poke.speciesName));
      });
      if (!eligible.length) return null;
      return eligible[Math.floor(Math.random() * eligible.length)];
    }

    // ...rest of your quiz logic (moves.csv/pokemon.json fetching, explanations, quiz, etc.) goes here...
    // (Make sure to call loadMetaAndApply() after moves/pokemon load)
    // Example:
    let moves = [], movesByName = {}, pokedex = [], currentPair = {};
    // Fetch moves.csv and pokemon.json automatically
    Promise.all([
      fetch('moves.csv').then(r => r.text()),
      fetch('pokemon.json').then(r => r.json())
    ]).then(([csvData, pokeData]) => {
      moves = parseCSV(csvData);
      movesByName = {};
      moves.forEach(mv => {
        movesByName[mv.Move.trim().toUpperCase().replace(/ /g, "_")] = mv;
        movesByName[mv.Move.trim()] = mv;
      });
      pokedex = pokeData;
      document.getElementById('loading').classList.add('hidden');
      document.getElementById('quizSection').classList.remove('hidden');
      showStats();
      loadMetaAndApply();
    });

    function parseCSV(data) {
      const lines = data.trim().split('\n');
      const headers = lines[0].split(',').map(h => h.trim());
      return lines.slice(1).map(line => {
        let cells = [], cell = '', inQuotes = false;
        for (let ch of line) {
          if (ch === '"') inQuotes = !inQuotes;
          else if (ch === ',' && !inQuotes) { cells.push(cell); cell = ''; }
          else cell += ch;
        }
        cells.push(cell);
        let obj = {};
        headers.forEach((h, i) => {
          obj[h] = cells[i] !== undefined ? cells[i].trim() : '';
          if (['Energy'].includes(h)) {
            obj[h] = obj[h] === '' ? NaN : parseInt(obj[h], 10);
          }
        });
        return obj;
      });
    }

    // ...rest of quiz logic (newQuestion, explanations, answerForm submit, etc)...
    // (same as your existing code, using pickEligiblePokemon for filtering)

    // Floating Next Button logic
    const fixedNextWrap = document.getElementById('fixedNextWrap');
    const fixedNextBtn = document.getElementById('fixedNextBtn');
    const closeNextBtn = document.getElementById('closeNextBtn');
    let floatingNextManuallyClosed = false;

    function showFixedNextButton(show) {
      if (show && !floatingNextManuallyClosed) fixedNextWrap.classList.add('show');
      else fixedNextWrap.classList.remove('show');
    }
    fixedNextBtn.onclick = function() {
      floatingNextManuallyClosed = false;
      showFixedNextButton(false);
      newQuestion();
    };
    closeNextBtn.onclick = function(e) {
      e.stopPropagation();
      floatingNextManuallyClosed = true;
      showFixedNextButton(false);
    };

    // ...rest of your event handlers and newQuestion logic...
    // (not repeated here for brevity)

  </script>
</body>
</html>